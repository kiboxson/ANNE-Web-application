<!DOCTYPE html>
<html>
<head>
    <title>ANNE App - Frontend-Backend Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        .test-result { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        input { padding: 8px; margin: 5px; width: 400px; border: 1px solid #ddd; border-radius: 3px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>üîó ANNE Web Application - Connection Test</h1>
    
    <div class="test-section info">
        <h3>üìã Connection Diagnostic Tool</h3>
        <p>This tool will test if your frontend can connect to your backend and identify any issues.</p>
    </div>

    <div class="grid">
        <div class="test-section">
            <h3>üåê Frontend Configuration</h3>
            <p><strong>Current Frontend URL:</strong> <span id="currentUrl">Loading...</span></p>
            <p><strong>Expected Backend URL:</strong></p>
            <input type="text" id="backendUrl" value="https://web-application-ecru-eight.vercel.app" placeholder="Enter your backend URL">
            <br>
            <button onclick="testConnection()">üß™ Test Connection</button>
            <button onclick="testAllEndpoints()">üîç Test All API Endpoints</button>
        </div>

        <div class="test-section">
            <h3>‚öôÔ∏è Quick Actions</h3>
            <button onclick="testCurrentConfig()">Test Current Config</button>
            <button onclick="findBackendUrl()">üîç Find Backend URL</button>
            <button onclick="testCORS()">Test CORS</button>
            <button onclick="generateFix()">üîß Generate Fix</button>
        </div>
    </div>

    <div id="results" class="test-section">
        <h3>üìä Test Results</h3>
        <div id="resultContent">Click a test button to start diagnostics...</div>
    </div>

    <div class="test-section info">
        <h3>üéØ What This Test Checks:</h3>
        <ul>
            <li><strong>Backend Availability:</strong> Is your backend URL accessible?</li>
            <li><strong>API Response:</strong> Does it return the expected JSON?</li>
            <li><strong>CORS Configuration:</strong> Can frontend make requests to backend?</li>
            <li><strong>Endpoint Testing:</strong> Are key API endpoints working?</li>
            <li><strong>Environment Config:</strong> Is the frontend using the right backend URL?</li>
        </ul>
    </div>

    <script>
        // Display current page URL
        document.getElementById('currentUrl').textContent = window.location.origin;

        // Test configuration from your actual setup
        const API_CONFIG = {
            // This simulates your frontend's API configuration
            BASE_URL: document.getElementById('backendUrl').value || 'https://web-application-ecru-eight.vercel.app',
            ENDPOINTS: {
                ROOT: '/',
                HEALTH: '/api/health/db',
                PRODUCTS: '/api/products',
                FLASH_PRODUCTS: '/api/flash-products',
                ORDERS: '/api/orders',
                CHAT: '/api/chat',
                USERS: '/api/users'
            }
        };

        async function testConnection() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            if (!backendUrl) {
                showResult('error', 'Please enter a backend URL');
                return;
            }

            showResult('info', 'üîÑ Testing connection to: ' + backendUrl);

            try {
                const response = await fetch(backendUrl);
                const data = await response.json();

                if (response.ok && data.message) {
                    if (data.message.includes('Backend API') || data.message.includes('ANNE')) {
                        showResult('success', `‚úÖ Backend Connected Successfully!
                        
URL: ${backendUrl}
Status: ${response.status}
Message: ${data.message}

Response:
${JSON.stringify(data, null, 2)}`);
                    } else {
                        showResult('warning', `‚ö†Ô∏è URL Responds but might not be your backend:
                        
URL: ${backendUrl}
Status: ${response.status}
Response: ${JSON.stringify(data, null, 2)}

This might be your frontend URL or a different API.`);
                    }
                } else {
                    showResult('error', `‚ùå Backend responded with error:
                    
Status: ${response.status}
Response: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showResult('error', `‚ùå Connection Failed:
                
URL: ${backendUrl}
Error: ${error.message}

Possible issues:
‚Ä¢ URL is incorrect
‚Ä¢ Backend is not deployed
‚Ä¢ CORS issues
‚Ä¢ Network connectivity problems`);
            }
        }

        async function testAllEndpoints() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            if (!backendUrl) {
                showResult('error', 'Please enter a backend URL');
                return;
            }

            showResult('info', 'üîÑ Testing all API endpoints...');

            const endpoints = [
                { name: 'Root', path: '/' },
                { name: 'Health Check', path: '/api/health/db' },
                { name: 'Products', path: '/api/products' },
                { name: 'Flash Products', path: '/api/flash-products' },
                { name: 'Orders', path: '/api/orders' },
                { name: 'Users', path: '/api/users' }
            ];

            let results = '<h4>üß™ API Endpoint Test Results:</h4>';
            let successCount = 0;

            for (const endpoint of endpoints) {
                const url = backendUrl + endpoint.path;
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        results += `<div class="success">‚úÖ ${endpoint.name}: Working (${response.status})</div>`;
                        successCount++;
                    } else {
                        results += `<div class="error">‚ùå ${endpoint.name}: Error ${response.status}</div>`;
                    }
                } catch (error) {
                    results += `<div class="error">‚ùå ${endpoint.name}: ${error.message}</div>`;
                }
            }

            results += `<div class="info"><strong>Summary:</strong> ${successCount}/${endpoints.length} endpoints working</div>`;

            if (successCount === endpoints.length) {
                results += '<div class="success">üéâ All endpoints are working! Your backend is fully functional.</div>';
            } else if (successCount > 0) {
                results += '<div class="warning">‚ö†Ô∏è Some endpoints are working. Backend is partially functional.</div>';
            } else {
                results += '<div class="error">‚ùå No endpoints are working. Backend connection failed.</div>';
            }

            showResult('info', results);
        }

        async function findBackendUrl() {
            showResult('info', 'üîç Searching for your backend URL...');

            const possibleUrls = [
                'https://anne-web-application-backend.vercel.app',
                'https://web-application-backend.vercel.app',
                'https://anne-backend.vercel.app',
                'https://kiboxson-anne-backend.vercel.app',
                'https://backend-anne.vercel.app',
                'https://anne-api.vercel.app',
                'https://web-application-api.vercel.app',
                'https://web-application-ecru-eight-backend.vercel.app'
            ];

            let results = '<h4>üîç Scanning Common Backend URL Patterns:</h4>';
            let foundBackend = null;

            for (const url of possibleUrls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.message && (data.message.includes('Backend') || data.message.includes('API'))) {
                            results += `<div class="success">‚úÖ BACKEND FOUND: ${url}</div>`;
                            foundBackend = url;
                            document.getElementById('backendUrl').value = url;
                            break;
                        } else {
                            results += `<div class="warning">‚ö†Ô∏è ${url}: Responds but not backend</div>`;
                        }
                    } else {
                        results += `<div class="error">‚ùå ${url}: Not accessible</div>`;
                    }
                } catch (error) {
                    results += `<div class="error">‚ùå ${url}: ${error.message}</div>`;
                }
            }

            if (foundBackend) {
                results += `<div class="success">üéâ Backend found at: ${foundBackend}
                
Next steps:
1. Update your .env.production file with this URL
2. Redeploy your frontend</div>`;
            } else {
                results += `<div class="error">‚ùå No backend found with common patterns.
                
Possible solutions:
1. Check your Vercel dashboard for the exact backend URL
2. Make sure your backend is deployed
3. Try testing your known backend URL manually</div>`;
            }

            showResult('info', results);
        }

        async function testCurrentConfig() {
            showResult('info', 'üîÑ Testing current configuration...');

            // Test the URL from your .env.production
            const configUrl = 'https://web-application-ecru-eight.vercel.app';
            
            let results = '<h4>üß™ Current Configuration Test:</h4>';
            results += `<p><strong>Testing URL:</strong> ${configUrl}</p>`;

            try {
                const response = await fetch(configUrl);
                const text = await response.text();

                // Check if it's HTML (frontend) or JSON (backend)
                if (text.includes('<!DOCTYPE html') || text.includes('<html')) {
                    results += `<div class="warning">‚ö†Ô∏è This URL returns HTML (Frontend App)
                    
<strong>Issue Found:</strong> Your .env.production is pointing to your FRONTEND URL, not backend!

<strong>Solution:</strong> You need to find your actual backend URL and update the configuration.</div>`;
                } else {
                    try {
                        const data = JSON.parse(text);
                        if (data.message && data.message.includes('Backend')) {
                            results += `<div class="success">‚úÖ Configuration is correct! This is your backend.</div>`;
                        } else {
                            results += `<div class="warning">‚ö†Ô∏è Returns JSON but might not be your backend:
${JSON.stringify(data, null, 2)}</div>`;
                        }
                    } catch (e) {
                        results += `<div class="error">‚ùå Invalid response format</div>`;
                    }
                }
            } catch (error) {
                results += `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
            }

            showResult('info', results);
        }

        async function testCORS() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            showResult('info', 'üîÑ Testing CORS configuration...');

            try {
                const response = await fetch(backendUrl + '/api/products', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    showResult('success', '‚úÖ CORS is working correctly! Frontend can make requests to backend.');
                } else {
                    showResult('warning', `‚ö†Ô∏è CORS might have issues. Status: ${response.status}`);
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    showResult('error', `‚ùå CORS Error: ${error.message}
                    
Your backend needs to allow requests from your frontend domain.`);
                } else {
                    showResult('error', `‚ùå Request failed: ${error.message}`);
                }
            }
        }

        function generateFix() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            
            const fixInstructions = `
<h4>üîß Fix Instructions:</h4>

<div class="info">
<strong>Step 1: Update .env.production</strong>
<pre>REACT_APP_API_URL=${backendUrl}</pre>

<strong>Step 2: Push changes</strong>
<pre>git add .
git commit -m "fix backend URL"
git push origin main</pre>

<strong>Step 3: Redeploy frontend on Vercel</strong>

<strong>Step 4: Test connection</strong>
Use this tool again to verify the connection works.
</div>`;

            showResult('info', fixInstructions);
        }

        function showResult(type, message) {
            const resultDiv = document.getElementById('resultContent');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            resultDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        // Auto-test current configuration on page load
        window.onload = function() {
            setTimeout(testCurrentConfig, 1000);
        };
    </script>
</body>
</html>
